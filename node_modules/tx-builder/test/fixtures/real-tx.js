const bitcoin = require('bitcoinjs-lib')
const { buildTx } = require('../../src/tx-builder')
const fixture = require('./hdnode')
console.log(`fixture`, fixture)

// //
// // 1. Send from regular to SegWit:
// //
//
// // From address: mm2zdwmiVBR7ipNiN3tr4CCu6sS5tFwKna
// // txid=dae8b7c3fe6d83a99ed4aa1e920679c43e3a0b43a6a6a5b2e8f2886895da78c7
// // vout=0
// // amount=1
// // To: tb1q8jr3q3s0cc7j0en5rhgeylcweeq7nd246575ce
//
// // hex: 0100000001c778da956888f2e8b2a5a6a6430b3a3ec47906921eaad49ea9836dfec3b7e8da000000006a4730440220419d674ccf85d96d82381fcd2a4ea8b93e461f54e235cd727b0d2471f8083a4f02205be9c8c47b7907ebb0057ac2c70edbda960442e00ec61c7a62b89109fa688ee3012103a6afa2211fc96a4130e767da4a9e802f5e922a151c5cd6d4bffa80358dd1f9a3feffffff0280f0fa02000000001600143c8710460fc63d27e6741dd1927f0ece41e9b55570c9fa02000000001976a9143c8710460fc63d27e6741dd1927f0ece41e9b55588ac00000000
// // txid: b6ecf4406bf054eb4d027057a7b8985c3decb09fd2c1680e88361db163181b7d
// // https://api-qa-wallet.equibitgroup.com/proxycore?node=btc&method=decoderawtransaction&params[]=0100000001c778da956888f2e8b2a5a6a6430b3a3ec47906921eaad49ea9836dfec3b7e8da000000006a4730440220419d674ccf85d96d82381fcd2a4ea8b93e461f54e235cd727b0d2471f8083a4f02205be9c8c47b7907ebb0057ac2c70edbda960442e00ec61c7a62b89109fa688ee3012103a6afa2211fc96a4130e767da4a9e802f5e922a151c5cd6d4bffa80358dd1f9a3feffffff0280f0fa02000000001600143c8710460fc63d27e6741dd1927f0ece41e9b55570c9fa02000000001976a9143c8710460fc63d27e6741dd1927f0ece41e9b55588ac00000000
// const txConfig = {
//   version: 1,
//   locktime: 0,  // 4 bytes (8 hex chars)
//   vin: [{
//     txid: 'dae8b7c3fe6d83a99ed4aa1e920679c43e3a0b43a6a6a5b2e8f2886895da78c7',
//     vout: 0,
//     keyPair: fixture.keyPair,
//     script: '',
//     sequence: 4294967294
//   }],
//   vout: [{
//     value: 0.5 * 100000000,
//     address: fixture.addressBech32,  // tb1q8jr3q3s0cc7j0en5rhgeylcweeq7nd246575ce
//     type: 'P2WPKH'
//   }, {
//     value: (0.5 - 0.0001) * 100000000,
//     address: fixture.address
//   }]
// }
// const buffer = buildTx(txConfig, {sha: 'SHA256'})
// const hex = buffer.toString('hex')
// console.log('hex:', hex)
//

//
// 2. Spend SegWit output
//

// From: tb1q8jr3q3s0cc7j0en5rhgeylcweeq7nd246575ce (addr0)
// txid: b6ecf4406bf054eb4d027057a7b8985c3decb09fd2c1680e88361db163181b7d
// vout: 0
// To: tb1qhn6l3jl02la469u5ad3x5a6juvw3k24tpxqxsx (addr1)

const txConfig2 = {
  version: 1,
  locktime: 0,  // 4 bytes (8 hex chars)
  vin: [{
    txid: 'b6ecf4406bf054eb4d027057a7b8985c3decb09fd2c1680e88361db163181b7d',
    vout: 0,
    keyPair: fixture.keyPair,
    type: 'P2WPKH',
    script: '',
    sequence: 4294967294
  }],
  vout: [{
    value: (0.5 - 0.0001) * 100000000,
    address: 'tb1qhn6l3jl02la469u5ad3x5a6juvw3k24tpxqxsx',  // tb1q8jr3q3s0cc7j0en5rhgeylcweeq7nd246575ce
    type: 'P2WPKH'
  }]
}
const buffer2 = buildTx(txConfig2, {sha: 'SHA256'})
const hex2 = buffer2.toString('hex')
console.log(`\n\nhex2: ${hex2}\n\n`)
// "error": {
//   "code": -26,
//   "message": "64: non-mandatory-script-verify-flag (Witness program hash mismatch)"
// }
// "error": {
//   "code": -26,
//   "message": "64: non-mandatory-script-verify-flag (Signature must be zero for failed CHECK(MULTI)SIG operation)"
// }

//
// 2a. Use P2WPKH example from
// http://n.bitcoin.ninja/checktx?txid=d869f854e1f8788bcff294cc83b280942a8c728de71eb709a2c29d10bfe21b7c
//

// Priv key: cNUnpYpMsJXYCERYBciJnsWBpcYEFjdcbq6dxj4SskGhs7uHuJ7Q (ex)
// txid: 56f87210814c8baef7068454e517a70da2f2103fc3ac7f687e32a228dc80e115
// vout: 1
// To: miCsSagJ7RQDCMcBUaKFKEryaLnxbhGAPt (ex)
const privKey = 'cNUnpYpMsJXYCERYBciJnsWBpcYEFjdcbq6dxj4SskGhs7uHuJ7Q'
// const privKey = 'KwDiBf89QgGbjEhKnhXJuH7LrciVrZi3qYjgd9M7rFU74sJxPeTm'
const keyPair = bitcoin.ECPair.fromWIF(privKey, bitcoin.networks.testnet)
const expectedHex = '0100000000010115e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f8560100000000ffffffff0100b4f505000000001976a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac02483045022100df7b7e5cda14ddf91290e02ea10786e03eb11ee36ec02dd862fe9a326bbcb7fd02203f5b4496b667e6e281cc654a2da9e4f08660c620a1051337fa8965f727eb19190121038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac00000000'
const txConfig2a = {
  version: 1,
  locktime: 0,  // 4 bytes (8 hex chars)
  vin: [{
    txid: '56f87210814c8baef7068454e517a70da2f2103fc3ac7f687e32a228dc80e115',
    vout: 1,
    keyPair,
    type: 'P2WPKH',
    script: '',
    sequence: 4294967295
  }],
  vout: [{
    value: 0.9998848 * 100000000,
    address: 'miCsSagJ7RQDCMcBUaKFKEryaLnxbhGAPt'
  }]
}
const buffer2a = buildTx(txConfig2a, {sha: 'SHA256'})
const hex2a = buffer2a.toString('hex')
console.log('\n\nhex2a:', hex2a)
console.log('expec:', expectedHex)

// hex2a:
// 0100000000010115e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f8560100000000ffffffff0100b4f505000000001976a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac02483045022100a364c9a7f37aad34a294807860e4fc013338895035afe9dbdbd915157944390302207414b5ba415f6f5bbde8a277cdf18290525a619d87078535e62387fa5cc3d6780121038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac00000000
// 01000000
// 00
// 01
// 01
// 15e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f856
// 01000000
// 00
// ffffffff
// 01
// 00b4f50500000000
// 19
// 76a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac
// 02 - witness length
// 48
// 3045022100a364c9a7f37aad34a294807860e4fc013338895035afe9dbdbd915157944390302207414b5ba415f6f5bbde8a277cdf18290525a619d87078535e62387fa5cc3d67801
// 21
// 038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac
// 00000000

// expected:
// 0100000000010115e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f8560100000000ffffffff0100b4f505000000001976a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac02483045022100df7b7e5cda14ddf91290e02ea10786e03eb11ee36ec02dd862fe9a326bbcb7fd02203f5b4496b667e6e281cc654a2da9e4f08660c620a1051337fa8965f727eb19190121038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac00000000
// 01000000
// 00
// 01
// 01
// 15e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f856
// 01000000
// 00
// ffffffff - sequence
// 01
// 00b4f50500000000
// 19
// 76a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac
// 02 - witness length  <<< !!!
// 48
// 3045022100df7b7e5cda14ddf91290e02ea10786e03eb11ee36ec02dd862fe9a326bbcb7fd02203f5b4496b667e6e281cc654a2da9e4f08660c620a1051337fa8965f727eb191901
// 21
// 038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac
// 00000000
