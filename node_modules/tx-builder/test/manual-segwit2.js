const varuint = require('varuint-bitcoin')
// const bitcoinjs = require('bitcoinjs-lib')
const Buffer = require('safe-buffer').Buffer
// const fixture = require('./fixtures/tx-hex-decoded')
// const fixtureNode = require('./fixtures/hdnode')
// const { signBuffer } = require('../src/tx-builder')

const actual = '0100000000010115e180dc28a2327e687facc33f10f2a20da717e5548406f7ae8b4c811072f8560100000000ffffffff0100b4f505000000001976a9141d7cd6c75c2e86f4cbf98eaed221b30bd9a0b92888ac02483045022100a364c9a7f37aad34a294807860e4fc013338895035afe9dbdbd915157944390302207414b5ba415f6f5bbde8a277cdf18290525a619d87078535e62387fa5cc3d6780121038262a6c6cec93c2d3ecd6c6072efea86d02ff8e3328bbd0242b20af3425990ac00000000'

const txHex = actual
const buffer = Buffer.from(txHex, 'hex')
// const keyPair = fixtureNode.keyPair
let offset = 0

// SegWit: `nVersion | marker | flag | txins | txouts | witness | nLockTime`
const version = buffer.readInt32LE(offset)
console.log(`* version = ${version}, offset=${offset}, length=4`)
offset += 4

const marker = buffer.readUInt8(offset)
console.log(`* marker = ${marker}, offset=${offset}, length=1`)
offset += 1

const flag = buffer.readUInt8(offset)
console.log(`* flag = ${flag}, offset=${flag}, length=1`)
offset += 1

// VIN:
const vinLen = varuint.decode(buffer, offset)
console.log(`* vinLen = ${vinLen}, offset=${offset}, length=${varuint.decode.bytes}`)
offset += varuint.decode.bytes

const readVin = (buffer, offset) => {
  // VIN-i:
  const hash = buffer.slice(offset, offset + 32)
  console.log(`* hash = ${hash.reverse().toString('hex')}, offset=${offset}, length=32`)
  offset += 32

  const index = buffer.readUInt32LE(offset)
  console.log(`* index = ${index}, offset=${offset}, length=4`)
  offset += 4

  const scriptSigLen = varuint.decode(buffer, offset)
  console.log(`* scriptLen = ${scriptSigLen}, offset=${offset}, length=${varuint.decode.bytes}`)
  offset += varuint.decode.bytes

  if (scriptSigLen) {
    const scriptSig = buffer.slice(offset, offset + scriptSigLen)
    console.log(`* scriptSig = ${scriptSig.toString('hex')}, offset=${offset}, length=${scriptSigLen}`)
    offset += scriptSigLen
  }

  const sequence = buffer.readUInt32LE(offset)
  console.log(`* sequence = ${sequence}, offset=${offset}, length=4`)
  offset += 4

  return offset
}

// READ VINs:
for (let i = 0; i < vinLen; i++) {
  console.log(`--- VIN-${i} ---`)
  offset = readVin(buffer, offset)
}

// VOUT
const voutLen = varuint.decode(buffer, offset)
console.log(`* voutLen = ${voutLen}, offset=${offset}, length=${varuint.decode.bytes}`)
offset += varuint.decode.bytes

// VOUT item:
const readVout = (buffer, offset) => {
  const valueA = buffer.readUInt32LE(offset)
  const valueB = buffer.readUInt32LE(offset + 4)
  const valueBB = valueB * 0x100000000
  const value = valueA + valueBB
  console.log(`* value = ${value}, offset=${offset}, length=8`)
  offset += 8

  const scriptPubKeyLen = varuint.decode(buffer, offset)
  console.log(`* scriptPubKeyLen = ${scriptPubKeyLen}, offset=${offset}, length=${varuint.decode.bytes}`)
  offset += varuint.decode.bytes

  const scriptPubKey = buffer.slice(offset, offset + scriptPubKeyLen)
  console.log(`* scriptPubKey = ${scriptPubKey.toString('hex')}, offset=${offset}, length=${scriptPubKeyLen}`)
  offset += scriptPubKeyLen

  return offset
}

// READ VOUTs:
for (let i = 0; i < voutLen; i++) {
  console.log(`--- VOUT-${i} ---`)
  offset = readVout(buffer, offset)
}

// Witnesses
const witnessesLen = varuint.decode(buffer, offset)
console.log(`* witnessesLen = ${witnessesLen}, offset=${offset}, length=${varuint.decode.bytes}`)
offset += varuint.decode.bytes

// READ Witnesses:
for (let i = 0; i < witnessesLen; i++) {
  console.log(`--- Witness-${i} ---`)
  offset = readWitness(buffer, offset)
}

function readWitness (buffer, offset) {
  const witnessLen = varuint.decode(buffer, offset)
  console.log(`* witnessLen = ${witnessLen}, offset=${offset}, length=${varuint.decode.bytes}`)
  offset += varuint.decode.bytes

  if (witnessLen) {
    const scriptSig = buffer.slice(offset, offset + witnessLen)
    console.log(`* scriptSig = ${scriptSig.toString('hex')}, offset=${offset}, length=${witnessLen}`)
    offset += witnessLen
  }

  return offset
}

// Locktime
const locktime = buffer.readUInt32LE(offset)
console.log(`* locktime = ${locktime}, offset=${offset}, length=4`)
offset += 4

console.log(`BUFFER LEFT = ${buffer.slice(offset).toString('hex')}`)
